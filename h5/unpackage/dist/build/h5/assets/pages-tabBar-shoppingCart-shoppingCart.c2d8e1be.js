import{_ as e,K as t,a1 as s,M as a,a2 as c,D as l,F as o,C as n,o as i,d,w as u,e as _,P as r,f as h,N as m,U as f,R as p,X as k,T as C,V as g,$ as b,a0 as v,h as y,k as L,a3 as I,a4 as P,Y as j,i as M,a5 as T}from"./vendor.e8d4713a.js";import{g as D,c as Z,f as x,d as B,a as F}from"./subscribe.d4f37143.js";import{l as S,s as V}from"./index.d1efd29a.js";const $=[{value:1,label:"去下单"},{value:2,label:"删除"}];var w=e(t({onShow:function(){s(),this.resetShoppingCart()},computed:{commodityData(){return console.log(this.cartMaterialList),this.cartMaterialList.map((e=>{const t=e.m_prices?e.m_prices[0].m_p_money:0;return console.log(t),e.m_price=(t/100).toFixed(2),e}))}},setup(){let{s_id:e,r_g_id:t}=S();const s=a(1),l=a({}),o=a([]),n=a([]),i=a(!1),d=a(!1),u=a({price:0,total:0}),_=()=>{B({s_id:e}).then((e=>{l.value=e.data}))},r=()=>{n.value=[],o.value=[],F({s_id:e}).then((e=>{e.data.map((e=>{const{m_stock:t=0,c_valid:s=0,m_c_count:a=0}=e;e.old_count=a,0==t||0==s?n.value.push(e):o.value.push(e)}));const t=e.data.filter((e=>e.m_stock>=e.m_c_count));console.log(t.length),d.value=t.length!==e.data.length&&2!=s.value,2==s.value&&0==e.data.length&&(s.value=1),console.log(n.value,o.value)}))},h=()=>{let e=o.value,t=0,a=0;e.forEach((e=>{if(1==s.value&&e.m_stock<e.m_c_count&&(e.checked=!1),e.checked&&e.m_stock>=e.m_c_count){const s=parseInt(e.m_c_count);a+=s||0;const c=e.m_price||0;t+=s*c}})),u.value={price:t,total:a},console.log(o.value)},m=()=>{let e=o.value;const t=e.length,a=e.filter((e=>e.checked)).length;i.value=t==a&&a>0;const c=e.filter((e=>e.m_stock>=e.m_c_count));d.value=c.length!==e.length&&2!=s.value},f=()=>{_(),h(),m()};return c(s,((e,t)=>{console.log(e),h(),m()})),{countAndPrice:l,cartMaterialList:o,toCartInsert:e=>{Z(e).then((e=>{f()}))},getCartList:r,getCartCountAndPrice:_,cbChecked:i,chosenCountPrice:u,operateData:$,operateType:s,stockZeroList:n,setChosenCountPrice:h,setCbChecked:m,resetShoppingCart:()=>{e=S().s_id,t=S().r_g_id,r(),f()},butFreshList:f,cbCheckDisabled:d,s_id:e,r_g_id:t}},methods:{checkboxChange(e){let t=this.cartMaterialList,s=e.detail.value;t.map((e=>{s.includes(e.m_id)?this.$set(e,"checked",!0):this.$set(e,"checked",!1)})),this.setChosenCountPrice(),this.setCbChecked()},changeCb(){this.cbCheckDisabled||(this.cbChecked=!this.cbChecked,this.setCheck(),this.setChosenCountPrice())},setCheck(){console.log(this.cartMaterialList),this.cartMaterialList.map((e=>{this.$set(e,"checked",this.cbChecked)}))},dataInput(e){this.setChosenCountPrice(),this.setCbChecked()},dataChange(e){let t="";if(isNaN(parseInt(e.m_c_count))?t="请填入数字":e.m_c_count.match(/^([1-9]+[0-9]*)$/)?parseInt(e.m_c_count)>e.m_stock&&(t="库存不足"):t="订购数量必须大于等于1",t)return e.m_c_count=e.old_count,l({title:t,duration:2e3,icon:"none"}),this.setChosenCountPrice(),void this.setCbChecked();const s=parseInt(e.m_c_count);e.m_c_count=s,e.old_count=s;const a={_id:e._id,s_id:this.s_id,m_c_count:s,m_id:e.m_id};console.log(a),console.log(e),D(a).then((e=>{this.butFreshList()}))},reduce(e){e.m_c_count--;const t={m_id:e.m_id,m_c_count:-1,m_c_unit:1,s_id:this.s_id};this.toCartInsert(t)},jian(e){console.log("减少",e);const t=this;e.m_c_count<=1?o({content:"是否确认删除该物料",showCancel:!0,success:function(s){if(s.confirm){const s=[e._id];t.deleteByIds(s)}}}):t.reduce(e)},jia(e){e.m_c_count++,e.checked&&e.m_c_count>e.m_stock&&(e.checked=!1);const t={m_id:e.m_id,m_c_count:1,m_c_unit:1,s_id:this.s_id};this.toCartInsert(t)},cartHandle(e){Z(e).then((e=>{this.getCartCountAndPrice()}))},submit(){const e=this.cartMaterialList.filter((e=>e.checked));console.log(e),0!=e.length?(V("orderMList",JSON.stringify(e)),n({url:"/pages/order/order"})):l({title:"您还没有选择物料哦",duration:2e3,icon:"none"})},deleteM(){const e=this.cartMaterialList.filter((e=>e.checked)).map((e=>e._id));this.delete(e)},deletesZeroList(){const e=this.stockZeroList.map((e=>e._id));this.delete(e)},delete(e){if(console.log(e),0==e.length)return void l({title:"没有需要删除的物料",duration:2e3,icon:"none"});const t=this;o({content:"确认将这些物料删除？",success:function(s){if(s.confirm)t.deleteByIds(e);else if(s.cancel)return}})},deleteByIds(e){x({ids:e}).then((e=>{l({title:"删除成功",duration:2e3,icon:"none"}),this.resetShoppingCart()}))}}}),[["render",function(e,t,s,a,c,l){const o=y,n=L,D=I,Z=M,x=T,B=P,F=j;return i(),d(n,{class:"shopping-container"},{default:u((()=>[_(n,{class:"title"},{default:u((()=>[_(n,{class:"left"},{default:u((()=>[r("span",{class:"icon iconfont icon-goumai"}),_(o,null,{default:u((()=>[h("购物车")])),_:1}),_(o,null,{default:u((()=>[h("("+m(e.countAndPrice.total||0)+")",1)])),_:1})])),_:1}),_(n,{class:"right"},{default:u((()=>[_(n,null,{default:u((()=>[_(o,null,{default:u((()=>[h("推荐")])),_:1})])),_:1}),_(n,null,{default:u((()=>[_(o,null,{default:u((()=>[h("常购")])),_:1})])),_:1}),_(n,{class:f(2==e.operateType?"operate":"")},{default:u((()=>[_(o,{class:"manage",onClick:t[0]||(t[0]=t=>e.operateType=1==e.operateType?2:1)},{default:u((()=>[h("管理")])),_:1}),2==e.operateType?(i(),p("span",{key:0,class:"icon iconfont icon-close"})):k("",!0)])),_:1},8,["class"])])),_:1})])),_:1}),_(n,{class:"commodityMod"},{default:u((()=>[_(B,{onChange:e.checkboxChange,class:"commodityList"},{default:u((()=>[(i(!0),p(g,null,C(e.commodityData,((t,s)=>(i(),d(n,{class:"commodityItem"},{default:u((()=>[_(D,{checked:t.checked,value:t.m_id,disabled:!(t.m_stock>=t.m_c_count||2==e.operateType)},null,8,["checked","value","disabled"]),_(Z,{src:t.img||"/static/logo.jpg"},null,8,["src"]),_(n,{class:"detail"},{default:u((()=>[_(n,{class:"name"},{default:u((()=>[h(m(t.m_name||"物料名称"),1)])),_:2},1024),_(n,{class:"unit"},{default:u((()=>[_(o,{class:"left"},{default:u((()=>[h(m(t.m_package),1)])),_:2},1024),b(_(o,{class:"right"},{default:u((()=>[h("该商品库存不足")])),_:2},1536),[[v,t.m_stock<t.m_c_count]])])),_:2},1024),_(n,{class:"price"},{default:u((()=>[_(o,{class:"total"},{default:u((()=>[r("span",{class:"icon iconfont icon-jine"}),t.m_prices?(i(),d(o,{key:0},{default:u((()=>[h(m(t.m_price),1)])),_:2},1024)):(i(),d(o,{key:1},{default:u((()=>[h("0")])),_:1}))])),_:2},1024),_(n,{class:"numHandle"},{default:u((()=>[_(o,{onClick:s=>e.jian(t)},{default:u((()=>[r("span",{class:"icon iconfont icon-jian"})])),_:2},1032,["onClick"]),_(x,{class:"uni-input",type:"number",modelValue:t.m_c_count,"onUpdate:modelValue":e=>t.m_c_count=e,onBlur:s=>e.dataChange(t),onInput:s=>e.dataInput(t),"auto-blur":"true"},null,8,["modelValue","onUpdate:modelValue","onBlur","onInput"]),_(o,{onClick:s=>e.jia(t)},{default:u((()=>[r("span",{class:"icon iconfont icon-tianjia"})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),256))])),_:1},8,["onChange"]),b(_(n,{class:"zeroList"},{default:u((()=>[_(n,null,{default:u((()=>[_(o,{class:"left"},{default:u((()=>[h("失效商品"+m(e.stockZeroList.length)+"件",1)])),_:1}),_(o,{class:"right",onClick:e.deletesZeroList},{default:u((()=>[h("清空失效商品")])),_:1},8,["onClick"])])),_:1}),(i(!0),p(g,null,C(e.stockZeroList,((t,s)=>(i(),d(n,{class:"commodityItem"},{default:u((()=>[_(Z,{src:t.img||"/static/logo.jpg"},null,8,["src"]),_(n,{class:"detail"},{default:u((()=>[_(n,{class:"name"},{default:u((()=>[h(m(t.m_name||"物料名称"),1)])),_:2},1024),0==e.c_valid?(i(),d(n,{key:0,class:"tip"},{default:u((()=>[h("商品已不能购买")])),_:1})):(i(),d(n,{key:1,class:"tip"},{default:u((()=>[h("商品库存不足")])),_:1}))])),_:2},1024)])),_:2},1024)))),256))])),_:1},512),[[v,e.stockZeroList.length>0]])])),_:1}),_(n,{class:"account"},{default:u((()=>[_(n,{class:"left"},{default:u((()=>[_(D,{value:"cb",checked:e.cbChecked,onClick:e.changeCb,disabled:e.cbCheckDisabled},null,8,["checked","onClick","disabled"]),h("全选 ")])),_:1}),_(n,{class:"right"},{default:u((()=>[1==e.operateType?(i(),d(n,{key:0},{default:u((()=>[e.chosenCountPrice.total>0?(i(),d(o,{key:0,class:"chosenTotal"},{default:u((()=>[h("已选"+m(e.chosenCountPrice.total)+"件,",1)])),_:1})):k("",!0),_(o,null,{default:u((()=>[h("总计:")])),_:1}),_(o,{class:"chosenPrice"},{default:u((()=>[r("span",{class:"icon iconfont icon-jine"}),h(m(e.chosenCountPrice.price.toFixed(2)),1)])),_:1}),_(F,{type:"primary",size:"mini",onClick:e.submit},{default:u((()=>[h("结算")])),_:1},8,["onClick"])])),_:1})):k("",!0),2==e.operateType?(i(),d(n,{key:1},{default:u((()=>[_(o,{onClick:t[1]||(t[1]=t=>e.operateType=1)},{default:u((()=>[h("取消")])),_:1}),_(F,{type:"warn",size:"mini",onClick:e.deleteM},{default:u((()=>[h("删除")])),_:1},8,["onClick"])])),_:1})):k("",!0)])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-822e1d18"]]);export{w as default};
