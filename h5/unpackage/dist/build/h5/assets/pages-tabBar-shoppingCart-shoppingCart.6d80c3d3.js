import{_ as e,D as t,Z as a,E as c,Y as s,X as l,G as n,o,d as i,w as d,e as u,K as _,f as r,F as h,O as m,M as f,R as p,N as k,P as C,V as g,W as b,h as y,k as v,$ as L,a0 as j,T as P,i as I,a1 as M}from"./vendor.6cfed29b.js";import{f as T,c as Z,e as D,d as B,a as N}from"./subscribe.6d98f777.js";import"./request.c3c876b8.js";import"./token.f74162db.js";const V=[{value:1,label:"去下单"},{value:2,label:"删除"}];var w=e(t({onShow:function(){a(),this.resetShoppingCart()},setup(){const e=c(1),t=c({}),a=c([]),s=c([]),l=c(!1),n=c(!1),o=c({price:0,total:0}),i=()=>{B({s_id:"10"}).then((e=>{t.value=e.data}))},d=()=>{s.value=[],a.value=[],N({s_id:"10"}).then((e=>{e.data.map((e=>{e.old_count=e.m_c_count})),e.data.map((e=>{0==e.m_stock||0==e.c_valid?s.value.push(e):a.value.push(e)}));const t=e.data.filter((e=>e.m_stock>e.m_c_count));console.log(t.length),n.value=t.length!==e.data.length,console.log(s.value,a.value)}))},u=()=>{let e=a.value,t=0,c=0;e.map((e=>{if(e.checked){c+=e.m_c_count||0;const a=e.m_prices?e.m_prices[0].m_p_money:0;t+=e.m_c_count*a}})),o.value={price:t,total:c}},_=()=>{let e=a.value;const t=e.length,c=e.filter((e=>e.checked)).length;l.value=t==c&&c>0},r=()=>{i(),u(),_()};return{countAndPrice:t,cartMaterialList:a,toCartInsert:e=>{Z(e).then((e=>{r()}))},getCartList:d,getCartCountAndPrice:i,cbChecked:l,chosenCountPrice:o,operateData:V,operateType:e,stockZeroList:s,setChosenCountPrice:u,setCbChecked:_,resetShoppingCart:()=>{d(),r()},butFreshList:r,cbCheckDisabled:n}},methods:{checkboxChange(e){let t=this.cartMaterialList,a=e.detail.value;t.map((e=>{a.includes(e.m_id)?this.$set(e,"checked",!0):this.$set(e,"checked",!1)})),this.setChosenCountPrice(),this.setCbChecked()},changeCb(){this.cbCheckDisabled||(this.cbChecked=!this.cbChecked,this.setCheck(),this.setChosenCountPrice())},setCheck(){this.cartMaterialList.map((e=>{this.$set(e,"checked",this.cbChecked)}))},dataChange(e){console.log(isNaN(parseInt(e.m_c_count)),e);const t=isNaN(parseInt(e.m_c_count))?e.old_count:parseInt(e.m_c_count);e.m_c_count=t;const a={_id:e._id,s_id:"10",m_c_count:t,m_id:e.m_id};console.log(a),console.log(e),T(a).then((e=>{this.butFreshList()}))},reduce(e){e.m_c_count--;const t={m_id:e.m_id,m_c_count:-1,m_c_unit:1,s_id:"10"};this.toCartInsert(t)},jian(e){console.log("减少",e);const t=this;e.m_c_count<=1?s({content:"是否确认删除该物料",showCancel:!0,success:function(a){if(a.confirm){const a=[e._id];t.deleteByIds(a)}}}):t.reduce(e)},jia(e){e.m_c_count++;const t={m_id:e.m_id,m_c_count:1,m_c_unit:1,s_id:"10"};this.toCartInsert(t)},cartHandle(e){Z(e).then((e=>{this.getCartCountAndPrice()}))},submit(){const e=this.cartMaterialList.filter((e=>e.checked));console.log(e),0!=e.length?n({url:"/pages/order/order",success:function(t){console.log("新的下订单"),t.eventChannel.emit("acceptDataFromOpenerPage",{data:{checkList:e}})}}):l({title:"您还没有选择物料哦",duration:2e3,icon:"none"})},deleteM(){const e=this.cartMaterialList.filter((e=>e.checked)).map((e=>e._id));this.delete(e)},deletesZeroList(){const e=this.stockZeroList.map((e=>e._id));this.delete(e)},delete(e){if(console.log(e),0==e.length)return void l({title:"没有需要删除的物料",duration:2e3,icon:"none"});const t=this;s({content:"确认将这些物料删除？",success:function(a){if(a.confirm)t.deleteByIds(e);else if(a.cancel)return}})},deleteByIds(e){D({ids:e}).then((e=>{l({title:"删除成功",duration:2e3,icon:"none"}),this.resetShoppingCart()}))}}}),[["render",function(e,t,a,c,s,l){const n=y,T=v,Z=L,D=I,B=M,N=j,V=P;return o(),i(T,{class:"shopping-container"},{default:d((()=>[u(T,{class:"title"},{default:d((()=>[u(T,{class:"left"},{default:d((()=>[_("span",{class:"icon iconfont icon-goumai"}),u(n,null,{default:d((()=>[r("购物车")])),_:1}),u(n,null,{default:d((()=>[r("("+h(e.countAndPrice.total||0)+")",1)])),_:1})])),_:1}),u(T,{class:"right"},{default:d((()=>[u(T,null,{default:d((()=>[u(n,null,{default:d((()=>[r("推荐")])),_:1})])),_:1}),u(T,null,{default:d((()=>[u(n,null,{default:d((()=>[r("常购")])),_:1})])),_:1}),u(T,{class:m(2==e.operateType?"operate":"")},{default:d((()=>[u(n,{class:"manage",onClick:t[0]||(t[0]=t=>e.operateType=1==e.operateType?2:1)},{default:d((()=>[r("管理")])),_:1}),2==e.operateType?(o(),f("span",{key:0,class:"icon iconfont icon-close"})):p("",!0)])),_:1},8,["class"])])),_:1})])),_:1}),u(T,{class:"commodityMod"},{default:d((()=>[u(N,{onChange:e.checkboxChange,class:"commodityList"},{default:d((()=>[(o(!0),f(C,null,k(e.cartMaterialList,((t,a)=>(o(),i(T,{class:"commodityItem"},{default:d((()=>[u(Z,{checked:t.checked,value:t.m_id,disabled:t.m_stock<t.m_c_count},null,8,["checked","value","disabled"]),u(D,{src:t.img||"/static/logo.jpg"},null,8,["src"]),u(T,{class:"detail"},{default:d((()=>[u(T,{class:"name"},{default:d((()=>[r(h(t.m_name||"物料名称"),1)])),_:2},1024),u(T,{class:"unit"},{default:d((()=>[u(n,{class:"left"},{default:d((()=>[r(h(t.m_package),1)])),_:2},1024),g(u(n,{class:"right"},{default:d((()=>[r("该商品库存不足")])),_:2},1536),[[b,t.m_stock<t.m_c_count]])])),_:2},1024),u(T,{class:"price"},{default:d((()=>[u(n,{class:"total"},{default:d((()=>[_("span",{class:"icon iconfont icon-jine"}),t.m_prices?(o(),i(n,{key:0},{default:d((()=>[r(h(t.m_prices[0].m_p_money),1)])),_:2},1024)):(o(),i(n,{key:1},{default:d((()=>[r("0")])),_:1}))])),_:2},1024),u(T,{class:"numHandle"},{default:d((()=>[u(n,{onClick:a=>e.jian(t)},{default:d((()=>[_("span",{class:"icon iconfont icon-jian"})])),_:2},1032,["onClick"]),u(B,{class:"uni-input",type:"number",modelValue:t.m_c_count,"onUpdate:modelValue":e=>t.m_c_count=e,onBlur:a=>e.dataChange(t),"auto-blur":"true"},null,8,["modelValue","onUpdate:modelValue","onBlur"]),u(n,{onClick:a=>e.jia(t)},{default:d((()=>[_("span",{class:"icon iconfont icon-tianjia"})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),256))])),_:1},8,["onChange"]),g(u(T,{class:"zeroList"},{default:d((()=>[u(T,null,{default:d((()=>[u(n,{class:"left"},{default:d((()=>[r("失效宝贝"+h(e.stockZeroList.length)+"件",1)])),_:1}),u(n,{class:"right",onClick:e.deletesZeroList},{default:d((()=>[r("清空失效宝贝")])),_:1},8,["onClick"])])),_:1}),(o(!0),f(C,null,k(e.stockZeroList,((t,a)=>(o(),i(T,{class:"commodityItem"},{default:d((()=>[u(Z,{checked:t.checked,value:t.m_id,disabled:""},null,8,["checked","value"]),u(D,{src:t.img||"/static/logo.jpg"},null,8,["src"]),u(T,{class:"detail"},{default:d((()=>[u(T,{class:"name"},{default:d((()=>[r(h(t.m_name||"物料名称"),1)])),_:2},1024),0==e.c_valid?(o(),i(T,{key:0,class:"tip"},{default:d((()=>[r("商品已不能购买")])),_:1})):(o(),i(T,{key:1,class:"tip"},{default:d((()=>[r("商品库存不足")])),_:1}))])),_:2},1024)])),_:2},1024)))),256))])),_:1},512),[[b,e.stockZeroList.length>0]])])),_:1}),u(T,{class:"account"},{default:d((()=>[u(T,{class:"left"},{default:d((()=>[u(Z,{value:"cb",checked:e.cbChecked,onClick:e.changeCb,disabled:e.cbCheckDisabled},null,8,["checked","onClick","disabled"]),r("全选 ")])),_:1}),u(T,{class:"right"},{default:d((()=>[1==e.operateType?(o(),i(T,{key:0},{default:d((()=>[e.chosenCountPrice.total>0?(o(),i(n,{key:0,class:"chosenTotal"},{default:d((()=>[r("已选"+h(e.chosenCountPrice.total)+"件，",1)])),_:1})):p("",!0),u(n,null,{default:d((()=>[r("总计:")])),_:1}),u(n,{class:"chosenPrice"},{default:d((()=>[_("span",{class:"icon iconfont icon-jine"}),r(h(e.chosenCountPrice.price),1)])),_:1}),u(V,{type:"primary",size:"mini",onClick:e.submit},{default:d((()=>[r("结算")])),_:1},8,["onClick"])])),_:1})):p("",!0),2==e.operateType?(o(),i(T,{key:1},{default:d((()=>[u(n,{onClick:t[1]||(t[1]=t=>e.operateType=1)},{default:d((()=>[r("取消")])),_:1}),u(V,{type:"warn",size:"mini",onClick:e.deleteM},{default:d((()=>[r("删除")])),_:1},8,["onClick"])])),_:1})):p("",!0)])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-1889a178"]]);export{w as default};
