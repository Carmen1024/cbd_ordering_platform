import{_ as e,K as t,a1 as c,M as s,D as a,F as l,C as n,o,d as i,w as d,e as u,P as _,f as r,N as h,U as m,R as f,X as p,T as k,V as C,$ as g,a0 as b,h as y,k as v,a2 as L,a3 as I,Y as P,i as j,a4 as M}from"./vendor.814d7eca.js";import{g as T,c as D,f as Z,d as x,a as B}from"./subscribe.e187e6ec.js";import{l as F,s as S}from"./index.e1c48d14.js";const V=[{value:1,label:"去下单"},{value:2,label:"删除"}];var $=e(t({onShow:function(){c(),this.resetShoppingCart()},computed:{commodityData(){return this.cartMaterialList.map((e=>{const t=e.m_prices?e.m_prices[0].m_p_money:0;return console.log(t),e.m_price=(t/100).toFixed(2),e}))}},setup(){let{s_id:e,r_g_id:t}=F();const c=s(1),a=s({}),l=s([]),n=s([]),o=s(!1),i=s(!1),d=s({price:0,total:0}),u=()=>{x({s_id:e}).then((e=>{a.value=e.data}))},_=()=>{n.value=[],l.value=[],B({s_id:e}).then((e=>{e.data.map((e=>{e.old_count=e.m_c_count})),e.data.map((e=>{0==e.m_stock||0==e.c_valid?n.value.push(e):l.value.push(e)}));const t=e.data.filter((e=>e.m_stock>=e.m_c_count));console.log(t.length),i.value=t.length!==e.data.length,2==c.value&&0==e.data.length&&(c.value=1),console.log(n.value,l.value)}))},r=()=>{let e=l.value,t=0,c=0;e.map((e=>{if(e.checked&&e.m_stock>e.m_c_count){const s=parseInt(e.m_c_count);c+=s||0;const a=e.m_price||0;t+=s*a}})),d.value={price:t,total:c}},h=()=>{let e=l.value;const t=e.length,c=e.filter((e=>e.checked)).length;o.value=t==c&&c>0;const s=e.filter((e=>e.m_stock>=e.m_c_count));i.value=s.length!==e.length},m=()=>{u(),r(),h()};return{countAndPrice:a,cartMaterialList:l,toCartInsert:e=>{D(e).then((e=>{m()}))},getCartList:_,getCartCountAndPrice:u,cbChecked:o,chosenCountPrice:d,operateData:V,operateType:c,stockZeroList:n,setChosenCountPrice:r,setCbChecked:h,resetShoppingCart:()=>{e=F().s_id,t=F().r_g_id,_(),m()},butFreshList:m,cbCheckDisabled:i,s_id:e,r_g_id:t}},methods:{checkboxChange(e){let t=this.cartMaterialList,c=e.detail.value;t.map((e=>{c.includes(e.m_id)?this.$set(e,"checked",!0):this.$set(e,"checked",!1)})),this.setChosenCountPrice(),this.setCbChecked()},changeCb(){this.cbCheckDisabled||(this.cbChecked=!this.cbChecked,this.setCheck(),this.setChosenCountPrice())},setCheck(){this.cartMaterialList.map((e=>{this.$set(e,"checked",this.cbChecked)}))},dataInput(e){this.setChosenCountPrice(),this.setCbChecked()},dataChange(e){let t="";if(isNaN(parseInt(e.m_c_count))?t="请填入数字":e.m_c_count.match(/^([1-9]+[0-9]*)$/)?parseInt(e.m_c_count)>e.m_stock&&(t="库存不足"):t="订购数量必须大于等于1",t)return e.m_c_count=e.old_count,a({title:t,duration:2e3,icon:"none"}),this.setChosenCountPrice(),void this.setCbChecked();const c=parseInt(e.m_c_count);e.m_c_count=c,e.old_count=c;const s={_id:e._id,s_id:this.s_id,m_c_count:c,m_id:e.m_id};console.log(s),console.log(e),T(s).then((e=>{this.butFreshList()}))},reduce(e){e.m_c_count--;const t={m_id:e.m_id,m_c_count:-1,m_c_unit:1,s_id:this.s_id};this.toCartInsert(t)},jian(e){console.log("减少",e);const t=this;e.m_c_count<=1?l({content:"是否确认删除该物料",showCancel:!0,success:function(c){if(c.confirm){const c=[e._id];t.deleteByIds(c)}}}):t.reduce(e)},jia(e){e.m_c_count++,e.checked&&e.m_c_count>e.m_stock&&(e.checked=!1);const t={m_id:e.m_id,m_c_count:1,m_c_unit:1,s_id:this.s_id};this.toCartInsert(t)},cartHandle(e){D(e).then((e=>{this.getCartCountAndPrice()}))},submit(){const e=this.cartMaterialList.filter((e=>e.checked));console.log(e),0!=e.length?(S("orderMList",JSON.stringify(e)),n({url:"/pages/order/order"})):a({title:"您还没有选择物料哦",duration:2e3,icon:"none"})},deleteM(){const e=this.cartMaterialList.filter((e=>e.checked)).map((e=>e._id));this.delete(e)},deletesZeroList(){const e=this.stockZeroList.map((e=>e._id));this.delete(e)},delete(e){if(console.log(e),0==e.length)return void a({title:"没有需要删除的物料",duration:2e3,icon:"none"});const t=this;l({content:"确认将这些物料删除？",success:function(c){if(c.confirm)t.deleteByIds(e);else if(c.cancel)return}})},deleteByIds(e){Z({ids:e}).then((e=>{a({title:"删除成功",duration:2e3,icon:"none"}),this.resetShoppingCart()}))}}}),[["render",function(e,t,c,s,a,l){const n=y,T=v,D=L,Z=j,x=M,B=I,F=P;return o(),i(T,{class:"shopping-container"},{default:d((()=>[u(T,{class:"title"},{default:d((()=>[u(T,{class:"left"},{default:d((()=>[_("span",{class:"icon iconfont icon-goumai"}),u(n,null,{default:d((()=>[r("购物车")])),_:1}),u(n,null,{default:d((()=>[r("("+h(e.countAndPrice.total||0)+")",1)])),_:1})])),_:1}),u(T,{class:"right"},{default:d((()=>[u(T,null,{default:d((()=>[u(n,null,{default:d((()=>[r("推荐")])),_:1})])),_:1}),u(T,null,{default:d((()=>[u(n,null,{default:d((()=>[r("常购")])),_:1})])),_:1}),u(T,{class:m(2==e.operateType?"operate":"")},{default:d((()=>[u(n,{class:"manage",onClick:t[0]||(t[0]=t=>e.operateType=1==e.operateType?2:1)},{default:d((()=>[r("管理")])),_:1}),2==e.operateType?(o(),f("span",{key:0,class:"icon iconfont icon-close"})):p("",!0)])),_:1},8,["class"])])),_:1})])),_:1}),u(T,{class:"commodityMod"},{default:d((()=>[u(B,{onChange:e.checkboxChange,class:"commodityList"},{default:d((()=>[(o(!0),f(C,null,k(e.commodityData,((t,c)=>(o(),i(T,{class:"commodityItem"},{default:d((()=>[u(D,{checked:t.checked&&t.m_stock>t.m_c_count,value:t.m_id,disabled:t.m_stock<t.m_c_count},null,8,["checked","value","disabled"]),u(Z,{src:t.img||"/static/logo.jpg"},null,8,["src"]),u(T,{class:"detail"},{default:d((()=>[u(T,{class:"name"},{default:d((()=>[r(h(t.m_name||"物料名称"),1)])),_:2},1024),u(T,{class:"unit"},{default:d((()=>[u(n,{class:"left"},{default:d((()=>[r(h(t.m_package),1)])),_:2},1024),g(u(n,{class:"right"},{default:d((()=>[r("该商品库存不足")])),_:2},1536),[[b,t.m_stock<t.m_c_count]])])),_:2},1024),u(T,{class:"price"},{default:d((()=>[u(n,{class:"total"},{default:d((()=>[_("span",{class:"icon iconfont icon-jine"}),t.m_prices?(o(),i(n,{key:0},{default:d((()=>[r(h(t.m_price),1)])),_:2},1024)):(o(),i(n,{key:1},{default:d((()=>[r("0")])),_:1}))])),_:2},1024),u(T,{class:"numHandle"},{default:d((()=>[u(n,{onClick:c=>e.jian(t)},{default:d((()=>[_("span",{class:"icon iconfont icon-jian"})])),_:2},1032,["onClick"]),u(x,{class:"uni-input",type:"number",modelValue:t.m_c_count,"onUpdate:modelValue":e=>t.m_c_count=e,onBlur:c=>e.dataChange(t),onInput:c=>e.dataInput(t),"auto-blur":"true"},null,8,["modelValue","onUpdate:modelValue","onBlur","onInput"]),u(n,{onClick:c=>e.jia(t)},{default:d((()=>[_("span",{class:"icon iconfont icon-tianjia"})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),256))])),_:1},8,["onChange"]),g(u(T,{class:"zeroList"},{default:d((()=>[u(T,null,{default:d((()=>[u(n,{class:"left"},{default:d((()=>[r("失效商品"+h(e.stockZeroList.length)+"件",1)])),_:1}),u(n,{class:"right",onClick:e.deletesZeroList},{default:d((()=>[r("清空失效商品")])),_:1},8,["onClick"])])),_:1}),(o(!0),f(C,null,k(e.stockZeroList,((t,c)=>(o(),i(T,{class:"commodityItem"},{default:d((()=>[u(D,{checked:t.checked,value:t.m_id,disabled:""},null,8,["checked","value"]),u(Z,{src:t.img||"/static/logo.jpg"},null,8,["src"]),u(T,{class:"detail"},{default:d((()=>[u(T,{class:"name"},{default:d((()=>[r(h(t.m_name||"物料名称"),1)])),_:2},1024),0==e.c_valid?(o(),i(T,{key:0,class:"tip"},{default:d((()=>[r("商品已不能购买")])),_:1})):(o(),i(T,{key:1,class:"tip"},{default:d((()=>[r("商品库存不足")])),_:1}))])),_:2},1024)])),_:2},1024)))),256))])),_:1},512),[[b,e.stockZeroList.length>0]])])),_:1}),u(T,{class:"account"},{default:d((()=>[u(T,{class:"left"},{default:d((()=>[u(D,{value:"cb",checked:e.cbChecked,onClick:e.changeCb,disabled:e.cbCheckDisabled},null,8,["checked","onClick","disabled"]),r("全选 ")])),_:1}),u(T,{class:"right"},{default:d((()=>[1==e.operateType?(o(),i(T,{key:0},{default:d((()=>[e.chosenCountPrice.total>0?(o(),i(n,{key:0,class:"chosenTotal"},{default:d((()=>[r("已选"+h(e.chosenCountPrice.total)+"件，",1)])),_:1})):p("",!0),u(n,null,{default:d((()=>[r("总计:")])),_:1}),u(n,{class:"chosenPrice"},{default:d((()=>[_("span",{class:"icon iconfont icon-jine"}),r(h(e.chosenCountPrice.price.toFixed(2)),1)])),_:1}),u(F,{type:"primary",size:"mini",onClick:e.submit},{default:d((()=>[r("结算")])),_:1},8,["onClick"])])),_:1})):p("",!0),2==e.operateType?(o(),i(T,{key:1},{default:d((()=>[u(n,{onClick:t[1]||(t[1]=t=>e.operateType=1)},{default:d((()=>[r("取消")])),_:1}),u(F,{type:"warn",size:"mini",onClick:e.deleteM},{default:d((()=>[r("删除")])),_:1},8,["onClick"])])),_:1})):p("",!0)])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-b7f9b94a"]]);export{$ as default};
