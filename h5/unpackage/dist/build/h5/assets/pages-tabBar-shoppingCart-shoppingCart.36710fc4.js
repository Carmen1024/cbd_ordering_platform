import{_ as e,D as t,$ as c,E as a,Y as s,Z as l,G as n,o,d as i,w as d,e as u,L as _,f as r,F as h,P as m,N as f,T as p,O as k,Q as C,W as g,X as b,h as v,k as y,a0 as L,a1 as j,U as P,i as I,a2 as M}from"./vendor.a21c6627.js";import{g as T,c as Z,f as B,d as D,a as S}from"./subscribe.c8a28c23.js";import{s as $}from"./token.ba774510.js";import"./request.c2d636c4.js";const w=[{value:1,label:"去下单"},{value:2,label:"删除"}];var A=e(t({onShow:function(){c(),this.resetShoppingCart()},setup(){const e=a(1),t=a({}),c=a([]),s=a([]),l=a(!1),n=a(!1),o=a({price:0,total:0}),i=()=>{D({s_id:"10"}).then((e=>{t.value=e.data}))},d=()=>{s.value=[],c.value=[],S({s_id:"10"}).then((t=>{t.data.map((e=>{e.old_count=e.m_c_count})),t.data.map((e=>{0==e.m_stock||0==e.c_valid?s.value.push(e):c.value.push(e)}));const a=t.data.filter((e=>e.m_stock>=e.m_c_count));console.log(a.length),n.value=a.length!==t.data.length,2==e.value&&0==t.data.length&&(e.value=1),console.log(s.value,c.value)}))},u=()=>{let e=c.value,t=0,a=0;e.map((e=>{if(e.checked){a+=e.m_c_count||0;const c=e.m_prices?e.m_prices[0].m_p_money:0;t+=e.m_c_count*c}})),o.value={price:t,total:a}},_=()=>{let e=c.value;const t=e.length,a=e.filter((e=>e.checked)).length;l.value=t==a&&a>0;const s=e.filter((e=>e.m_stock>=e.m_c_count));n.value=s.length!==e.length},r=()=>{i(),u(),_()};return{countAndPrice:t,cartMaterialList:c,toCartInsert:e=>{Z(e).then((e=>{r()}))},getCartList:d,getCartCountAndPrice:i,cbChecked:l,chosenCountPrice:o,operateData:w,operateType:e,stockZeroList:s,setChosenCountPrice:u,setCbChecked:_,resetShoppingCart:()=>{d(),r()},butFreshList:r,cbCheckDisabled:n}},methods:{checkboxChange(e){let t=this.cartMaterialList,c=e.detail.value;t.map((e=>{c.includes(e.m_id)?this.$set(e,"checked",!0):this.$set(e,"checked",!1)})),this.setChosenCountPrice(),this.setCbChecked()},changeCb(){this.cbCheckDisabled||(this.cbChecked=!this.cbChecked,this.setCheck(),this.setChosenCountPrice())},setCheck(){this.cartMaterialList.map((e=>{this.$set(e,"checked",this.cbChecked)}))},dataChange(e){let t="";if(isNaN(parseInt(e.m_c_count))?t="请填入数字":e.m_c_count.match(/^([1-9]+[0-9]*)$/)?parseInt(e.m_c_count)>e.m_stock&&(t="库存不足"):t="订购数量必须大于等于1",t)return e.m_c_count=e.old_count,void s({title:t,duration:2e3,icon:"none"});const c=parseInt(e.m_c_count);e.m_c_count=c;const a={_id:e._id,s_id:"10",m_c_count:c,m_id:e.m_id};console.log(a),console.log(e),T(a).then((e=>{this.butFreshList()}))},reduce(e){e.m_c_count--;const t={m_id:e.m_id,m_c_count:-1,m_c_unit:1,s_id:"10"};this.toCartInsert(t)},jian(e){console.log("减少",e);const t=this;e.m_c_count<=1?l({content:"是否确认删除该物料",showCancel:!0,success:function(c){if(c.confirm){const c=[e._id];t.deleteByIds(c)}}}):t.reduce(e)},jia(e){e.m_c_count++,e.checked&&e.m_c_count>e.m_stock&&(e.checked=!1);const t={m_id:e.m_id,m_c_count:1,m_c_unit:1,s_id:"10"};this.toCartInsert(t)},cartHandle(e){Z(e).then((e=>{this.getCartCountAndPrice()}))},submit(){const e=this.cartMaterialList.filter((e=>e.checked));console.log(e),0!=e.length?($("orderMList",JSON.stringify(e)),n({url:"/pages/order/order"})):s({title:"您还没有选择物料哦",duration:2e3,icon:"none"})},deleteM(){const e=this.cartMaterialList.filter((e=>e.checked)).map((e=>e._id));this.delete(e)},deletesZeroList(){const e=this.stockZeroList.map((e=>e._id));this.delete(e)},delete(e){if(console.log(e),0==e.length)return void s({title:"没有需要删除的物料",duration:2e3,icon:"none"});const t=this;l({content:"确认将这些物料删除？",success:function(c){if(c.confirm)t.deleteByIds(e);else if(c.cancel)return}})},deleteByIds(e){B({ids:e}).then((e=>{s({title:"删除成功",duration:2e3,icon:"none"}),this.resetShoppingCart()}))}}}),[["render",function(e,t,c,a,s,l){const n=v,T=y,Z=L,B=I,D=M,S=j,$=P;return o(),i(T,{class:"shopping-container"},{default:d((()=>[u(T,{class:"title"},{default:d((()=>[u(T,{class:"left"},{default:d((()=>[_("span",{class:"icon iconfont icon-goumai"}),u(n,null,{default:d((()=>[r("购物车")])),_:1}),u(n,null,{default:d((()=>[r("("+h(e.countAndPrice.total||0)+")",1)])),_:1})])),_:1}),u(T,{class:"right"},{default:d((()=>[u(T,null,{default:d((()=>[u(n,null,{default:d((()=>[r("推荐")])),_:1})])),_:1}),u(T,null,{default:d((()=>[u(n,null,{default:d((()=>[r("常购")])),_:1})])),_:1}),u(T,{class:m(2==e.operateType?"operate":"")},{default:d((()=>[u(n,{class:"manage",onClick:t[0]||(t[0]=t=>e.operateType=1==e.operateType?2:1)},{default:d((()=>[r("管理")])),_:1}),2==e.operateType?(o(),f("span",{key:0,class:"icon iconfont icon-close"})):p("",!0)])),_:1},8,["class"])])),_:1})])),_:1}),u(T,{class:"commodityMod"},{default:d((()=>[u(S,{onChange:e.checkboxChange,class:"commodityList"},{default:d((()=>[(o(!0),f(C,null,k(e.cartMaterialList,((t,c)=>(o(),i(T,{class:"commodityItem"},{default:d((()=>[u(Z,{checked:t.checked,value:t.m_id,disabled:t.m_stock<t.m_c_count},null,8,["checked","value","disabled"]),u(B,{src:t.img||"/static/logo.jpg"},null,8,["src"]),u(T,{class:"detail"},{default:d((()=>[u(T,{class:"name"},{default:d((()=>[r(h(t.m_name||"物料名称"),1)])),_:2},1024),u(T,{class:"unit"},{default:d((()=>[u(n,{class:"left"},{default:d((()=>[r(h(t.m_package),1)])),_:2},1024),g(u(n,{class:"right"},{default:d((()=>[r("该商品库存不足")])),_:2},1536),[[b,t.m_stock<t.m_c_count]])])),_:2},1024),u(T,{class:"price"},{default:d((()=>[u(n,{class:"total"},{default:d((()=>[_("span",{class:"icon iconfont icon-jine"}),t.m_prices?(o(),i(n,{key:0},{default:d((()=>[r(h(t.m_prices[0].m_p_money),1)])),_:2},1024)):(o(),i(n,{key:1},{default:d((()=>[r("0")])),_:1}))])),_:2},1024),u(T,{class:"numHandle"},{default:d((()=>[u(n,{onClick:c=>e.jian(t)},{default:d((()=>[_("span",{class:"icon iconfont icon-jian"})])),_:2},1032,["onClick"]),u(D,{class:"uni-input",type:"number",modelValue:t.m_c_count,"onUpdate:modelValue":e=>t.m_c_count=e,onBlur:c=>e.dataChange(t),"auto-blur":"true"},null,8,["modelValue","onUpdate:modelValue","onBlur"]),u(n,{onClick:c=>e.jia(t)},{default:d((()=>[_("span",{class:"icon iconfont icon-tianjia"})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),256))])),_:1},8,["onChange"]),g(u(T,{class:"zeroList"},{default:d((()=>[u(T,null,{default:d((()=>[u(n,{class:"left"},{default:d((()=>[r("失效商品"+h(e.stockZeroList.length)+"件",1)])),_:1}),u(n,{class:"right",onClick:e.deletesZeroList},{default:d((()=>[r("清空失效商品")])),_:1},8,["onClick"])])),_:1}),(o(!0),f(C,null,k(e.stockZeroList,((t,c)=>(o(),i(T,{class:"commodityItem"},{default:d((()=>[u(Z,{checked:t.checked,value:t.m_id,disabled:""},null,8,["checked","value"]),u(B,{src:t.img||"/static/logo.jpg"},null,8,["src"]),u(T,{class:"detail"},{default:d((()=>[u(T,{class:"name"},{default:d((()=>[r(h(t.m_name||"物料名称"),1)])),_:2},1024),0==e.c_valid?(o(),i(T,{key:0,class:"tip"},{default:d((()=>[r("商品已不能购买")])),_:1})):(o(),i(T,{key:1,class:"tip"},{default:d((()=>[r("商品库存不足")])),_:1}))])),_:2},1024)])),_:2},1024)))),256))])),_:1},512),[[b,e.stockZeroList.length>0]])])),_:1}),u(T,{class:"account"},{default:d((()=>[u(T,{class:"left"},{default:d((()=>[u(Z,{value:"cb",checked:e.cbChecked,onClick:e.changeCb,disabled:e.cbCheckDisabled},null,8,["checked","onClick","disabled"]),r("全选 ")])),_:1}),u(T,{class:"right"},{default:d((()=>[1==e.operateType?(o(),i(T,{key:0},{default:d((()=>[e.chosenCountPrice.total>0?(o(),i(n,{key:0,class:"chosenTotal"},{default:d((()=>[r("已选"+h(e.chosenCountPrice.total)+"件，",1)])),_:1})):p("",!0),u(n,null,{default:d((()=>[r("总计:")])),_:1}),u(n,{class:"chosenPrice"},{default:d((()=>[_("span",{class:"icon iconfont icon-jine"}),r(h(e.chosenCountPrice.price),1)])),_:1}),u($,{type:"primary",size:"mini",onClick:e.submit},{default:d((()=>[r("结算")])),_:1},8,["onClick"])])),_:1})):p("",!0),2==e.operateType?(o(),i(T,{key:1},{default:d((()=>[u(n,{onClick:t[1]||(t[1]=t=>e.operateType=1)},{default:d((()=>[r("取消")])),_:1}),u($,{type:"warn",size:"mini",onClick:e.deleteM},{default:d((()=>[r("删除")])),_:1},8,["onClick"])])),_:1})):p("",!0)])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-4d13cf10"]]);export{A as default};
